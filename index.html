<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TERRAVERA™ | Visualizing the value chain </title>
  <meta name="description" content="Visualizing the value chain of Evaluations of Entities in the TERRAVERA™ Platform">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="https://tord-s.github.io/vc/favicon.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.20.0/cytoscape.min.js"
    integrity="sha512-cjmYAonfXK+azDmWqvnqq8xmygHRHqVI7S0zuRxQnvcYVeoakwthRX6pPKoXfG1oIjDvMUtteRV9PhQjJwKWxQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/cytoscape-klay@3.1.4/cytoscape-klay.min.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.3.2/cytoscape-dagre.min.js"></script>
  <script src="https://cdn.rawgit.com/cpettitt/dagre/v0.7.4/dist/dagre.min.js"></script>
  <script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-dagre/1.5.0/cytoscape-dagre.js"></script>
</head>

<body>
  <script type="module">
    import { createApp, reactive } from 'https://unpkg.com/petite-vue?module'

    const store = reactive({
      showData: false,
      groupEntities: true,
      loading: 1,
      loadingNode: true,
      rawJSONFromApi: "",
      originalStartID: 42000000,
      valueChainElements: [],
      showDetails: false,
      nodeDetails: '',
      nodeDetailsName: '',
      nodeDetailsAssetType: '',
      apiBasePath: 'https://v02.platform.terravera.world',
      toggleShowData() {
        this.showData = !this.showData;
      },
      toggleGroupEntities() {
        this.groupEntities = !this.groupEntities;
      },
      async getNodeDetails() {
        let asset_type_url = ''
        if (store.nodeDetailsAssetType === 'entity') {
          asset_type_url = '/library/entities/'
        } else if (store.nodeDetailsAssetType === 'dataset') {
          asset_type_url = '/data/datasets/'
        }
        store.loadingNode = true;
        store.showDetails = true;
        let getDetails = new Promise(function (detailsResolved, detailsNotFound) {
          let req = new XMLHttpRequest();
          req.open('GET', store.apiBasePath + asset_type_url + store.nodeDetailsName);
          req.onload = function () {
            if (req.status == 200) {
              detailsResolved(req.response);
              store.loadingNode = false;
            } else {
              store.loadingNode = false;
              store.nodeDetails = { error: "An error occured" }
            }
          };
          req.send();
        });
        getDetails.then(
          function (value) {
            store.nodeDetails = JSON.parse(value)
          },
          function (error) { alert(error); }
        );
      }
    })

    createApp({
      store,
      inizialize() {
        function main() {
          // Converting JSON-encoded string to JS object
          let data_obj = JSON.parse(store.rawJSONFromApi);
          let graph = data_obj.graph
          let nodes = graph.nodes
          let edges = graph.edges
          let valueChainElements = []

          for (const node in nodes) {
            let node_data = nodes[node]
            if (store.groupEntities) {
              // valueChainElements.push({ data: { id: node, name: node_data.label,
              // color: (node_data['meta_data'].type === "instance") ? "#c5fa9c" : "white" } })
              valueChainElements.push({
                data: {
                  id: node, parent: node_data.parent, asset_type: node_data['meta_data'].type,
                  name: node_data.label, color: (node_data['meta_data'].type === "instance") ? "#c5fa9c" : "white"
                }
              })
              // valueChainElements.push({ data: { id: node, name: node_data.label + ' ' + node.slice(-4),
              // color: (node_data['meta_data'].type === "instance") ? "#c5fa9c" : "white" } })
            }
            else {
              valueChainElements.push({
                data: {
                  id: node, name: node_data.label, asset_type: node_data['meta_data'].type,
                  color: (node_data['meta_data'].type === "instance") ? "#c5fa9c" : "white"
                }
              })
            }
          }

          let start_id = store.originalStartID
          for (const edge in edges) {
            let edge_data = edges[edge]
            valueChainElements.push({
              data: {
                id: start_id, desc: edge_data.relation,
                source: edge_data.source, target: edge_data.target
              }
            })
            start_id += 1
          }

          var cy = cytoscape({
            container: document.getElementById('cy'),
            elements: valueChainElements,
            style: [
              {
                selector: 'node',
                css: {
                  'label': 'data(name)',
                  'background-color': 'data(color)',
                  'border-color': 'black',
                  'shape': 'circle',
                  'cursor': 'pointer',
                  height: '50px',
                  width: '50px',
                  shape: 'square',
                }
              },
              {
                selector: ':parent',
                css: {
                  'text-valign': 'top',
                  'background-color': '#18332f',
                  'text-halign': 'center',
                  'padding': '30px',
                  'shape': 'square',
                }
              },
              {
                selector: 'edge',
                css: {
                  'line-color': '#c5fa9c',
                  'label': 'data(desc)',
                  'curve-style': 'bezier',
                  'arrow-scale': '2',
                  'target-arrow-color': '#c5fa9c',
                  'target-arrow-shape': 'triangle'
                }
              },
              {
                selector: 'label',
                style: {
                  'font-size': '22px',
                  'text-background-color': 'black',
                  'color': 'white',
                  'text-background-opacity': 1,
                }
              },
              {
                selector: ':parent > node',
                style: {
                  'text-background-color': '#18332f',
                  'color': 'white',
                  'background-color': '#c5fa9c'
                }
              },
              {
                selector: 'node.highlight',
                style: {
                  'border-color': 'white',
                  'border-width': '4px',
                  // 'font-size': '28px',
                  "transition-timing-function": 'ease-in-out',
                  "transition-duration": '0.3s',
                  "transition-property": 'border-width, border-color, font-size',
                }
              }
            ],
          });

          cy.on('click', 'node', function (evt) {
            let asset_type = (this.data().asset_type === "dataset") ? "dataset" : "entity"
            store.nodeDetailsAssetType = asset_type
            store.nodeDetailsName = this.data().name
            store.getNodeDetails();
          });

          // Don't realyly use this as of now, but was cool
          // cy.on('mouseover', 'node', function (evt) {
          //   console.log('Mouseover ', this.data().name)
          // });

          // adds cursor on hover over nodes and class highlight
          cy.on('mouseover', 'node', (event) => {
            if (event.cy.container()) {
              event.cy.container().style.cursor = 'pointer';
            }
            event.target.addClass('highlight');
          })
          cy.on('mouseout', 'node', (event) => {
            if (event.cy.container()) {
              event.cy.container().style.cursor = 'default';
            }
            event.target.removeClass('highlight');
          })

          const data_toggle = document.querySelector('#hide_data');
          data_toggle.onclick = () => {
            store.toggleShowData();
            main();
          };
          hideData();

          const entity_toggle = document.querySelector('#group_entities');
          entity_toggle.onclick = () => {
            store.toggleGroupEntities();
            main();
          };

          function hideData() {
            const dataset_nodes = cy.elements('node[color = "white"]')
            const dataset_edges = cy.edges('[desc = "data"]');
            if (!store.showData) {
              cy.remove(dataset_nodes);
              cy.remove(dataset_edges);
              animate();
            }
            else {
              cy.add(dataset_nodes);
              cy.add(dataset_edges);
              animate();
            }
          }

          function getParent(target_id) {
            for (let node in nodes) {
              let node_data = nodes[node]
              if (node === target_id) {
                return node_data.parent
              }
            }
            return -1
          }

          // Need to check if the edge has a source that is equal to the parent of the 
          // target node and remove this in the group view
          if (store.groupEntities) {
            for (let i = 0; i < edges.length; i++) {
              const edge = edges[i];
              if (getParent(edge.target) === edge.source) {
                const q = '[target = "' + edge.target + '"][source = "' + edge.source + '"]'
                cy.remove(cy.edges(q))
              }
            }
            animate();
          }

          function animate() {
            var layout = cy.layout({
              name: 'dagre',
              animate: true,
              animationDuration: 800,
              animationEasing: 'ease-in-out',
              rankDir: 'RL',
              edgeSep: 50,
              nodeSep: 150,
              rankSep: 120,
              padding: 30,
              nodeDimensionsIncludeLabels: true,
            });
            layout.run();
          }
          setTimeout(
            animate, 800);
        }

        async function start() {
          let myPromise = new Promise(function (myResolve, myReject) {
            setTimeout(function () {
              let req = new XMLHttpRequest();
              req.open('GET', "eval.json");
              req.onload = function () {
                if (req.status == 200) {
                  myResolve(req.response);
                }
              };
              req.send();
            }, 1900);
          });

          myPromise.then(
            function (value) {
              store.rawJSONFromApi = value;
              main();
              store.loading = 0
              document.getElementById('loading').style['z-index'] = -1;
            },
            function (error) { alert(error); }
          );
        }
        start();
      },
      getFurtherDetails(name, asset_type) {
        store.nodeDetailsName = name;
        store.nodeDetailsAssetType = asset_type
        store.getNodeDetails()
      }
    }
    ).mount()
  </script>

  <div id="loading" v-scope opacity="store.loading">
    <img class="loading_logo" src="https://tord-s.github.io/vc/formue_logo.png" alt="Formuesforvaltning logo"
      width="420px" height="100px">
  </div>
  <div class="controls" v-scope>
    <div class="param">
      <h4 class="group_entities_toggle">Data:</h4>
      <label class="switch">
        <input class="switch-input" type="checkbox" name="hide_data" id="hide_data" unchecked="store.showData" />
        <span class="switch-label" data-on="Hide" data-off="Show"></span> <span class="switch-handle"></span>
      </label>
      <h4 class="group_entities_toggle">Entities:</h4>
      <label class="switch">
        <input class="switch-input" type="checkbox" name="group_entities" id="group_entities"
          checked="store.groupEntities">
        <span class="switch-label" data-on="Ungroup" data-off="Group"></span> <span class="switch-handle"></span>
      </label>
    </div>
    <div class="explainations">
      <p><i><b>Transposing</b></i> an Entity means to put the Entity in a new context. For instance when a product
        moves from one processing step to another.</p>
      <p>An <i><b>import</b></i> signifies a relationship where one Entity depends on another. For instance a car
        depends on the metal of which it constitutes, or a consumer depends on food.</p>
    </div>
  </div>
  <div id="cy" v-scope @vue:mounted="inizialize()"></div>
  <div class="node_details content-fade-up-animation" v-scope v-if="store.showDetails">
    <button class="close_node_details" @click="store.showDetails = false">Close</button>
    <div class="loading" v-if="store.loadingNode">
      <div class="loader"></div>
    </div>
    <div class="node_details_content" v-else>
      <div v-if="store.nodeDetails.error" class="details_error">
        Unable to get details ⚠️<br>
        <a href="mailto:tord.softeland@terravera.world">
          Send email to developer 📧
        </a>
      </div>
      <div v-else>
        <div class="top_line_details">
          <b>{{store.nodeDetails.name }} details:</b>
          <small>Last edit:
            <span v-if="item.datetime_last_changed != null">{{item.datetime_last_changed}}</span>
            <span v-else>N/A</span>
          </small>
        </div>
        <fieldset v-if="store.nodeDetails.entity_inherits.length > 0" class="node_detail">
          <legend>Entity Inherits:</legend>
          <div v-for="item in store.nodeDetails.entity_inherits">
            <b class="furter_details" @click="getFurtherDetails(item.inherited_entity_name, 'entity')">{{
              item.inherited_entity_name }}</b> with
            priority
            {{
            item.priority }}
          </div>
        </fieldset>
        <fieldset v-if="store.nodeDetails.dataset_pointers.length > 0" class="node_detail">
          <legend>Dataset Pointers:</legend>
          <div v-for=" item in store.nodeDetails.dataset_pointers">
            {{ item.name }} with default <b class="furter_details"
              @click="getFurtherDetails(item.default_dataset_name, 'dataset')"> {{ item.default_dataset_name }}</b>
        </fieldset>
      </div>
    </div>
  </div>
  </div>
</body>

</html>