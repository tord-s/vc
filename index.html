<!DOCTYPE html>
<html lang="en">

<!-- https://blog.js.cytoscape.org/2016/05/24/getting-started/ -->

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TERRAVERAâ„¢ | Visualizing the value chain </title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="./favicon.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.20.0/cytoscape.min.js"
    integrity="sha512-cjmYAonfXK+azDmWqvnqq8xmygHRHqVI7S0zuRxQnvcYVeoakwthRX6pPKoXfG1oIjDvMUtteRV9PhQjJwKWxQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/cytoscape-klay@3.1.4/cytoscape-klay.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.3.2/cytoscape-dagre.min.js"></script>
  <script src="https://cdn.rawgit.com/cpettitt/dagre/v0.7.4/dist/dagre.min.js"></script>
  <script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-dagre/1.5.0/cytoscape-dagre.js"></script>
</head>

<style>

</style>

<body>
  <div id="loading">
    <svg id="logo_svg" width="287" height="95" viewBox="0 0 287 95" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M10.7592 65.7788H0V61.3354H27.1592V65.7788H16.4522V95.0002H10.7592V65.7788Z" fill="white"></path>
      <path
        d="M32.7472 61.3354H56.1981V65.7788H38.4402V75.9723H54.2656V80.3633H38.4402V90.6091H56.1981V95.0002H32.7472V61.3354Z"
        fill="white"></path>
      <path
        d="M62.5186 61.3353H78.0133C79.4928 61.2149 80.981 61.4036 82.3837 61.8896C83.7863 62.3755 85.0727 63.1481 86.1611 64.1581C88.0507 66.3575 89.0066 69.2089 88.8248 72.1038C88.9133 74.2656 88.3028 76.3983 87.0838 78.1851C85.8276 79.8844 84.0372 81.1117 82.0002 81.6701C82.548 82.0417 83.0254 82.5078 83.4104 83.0466C83.8497 83.733 84.2173 84.4629 84.5072 85.2247L88.7378 95H82.7836L78.6575 85.5906C78.3643 84.81 77.8575 84.1276 77.1951 83.6216C76.3741 83.1987 75.4521 83.0117 74.5314 83.0815H68.2116V95H62.5186V61.3353ZM76.4465 78.4813C80.8685 78.4813 83.0796 76.3555 83.0796 72.1038C83.0796 67.8522 81.0426 65.7438 76.9688 65.7786H68.2639V78.5336L76.4465 78.4813Z"
        fill="white"></path>
      <path
        d="M95.4224 61.3353H110.882C112.362 61.2149 113.85 61.4036 115.253 61.8896C116.655 62.3755 117.942 63.1481 119.03 64.1581C120.92 66.3575 121.876 69.2089 121.694 72.1038C121.782 74.2656 121.172 76.3983 119.953 78.1851C118.696 79.8844 116.906 81.1117 114.869 81.6701C115.417 82.0417 115.894 82.5078 116.279 83.0466C116.719 83.733 117.086 84.4629 117.376 85.2247L121.537 95H115.687L111.561 85.5906C111.268 84.81 110.761 84.1276 110.099 83.6216C109.278 83.1987 108.356 83.0117 107.435 83.0815H101.115V95H95.4224V61.3353ZM109.35 78.5336C113.772 78.5336 115.983 76.4078 115.983 72.1561C115.983 67.9045 113.946 65.7961 109.872 65.8309H101.168V78.5336H109.35Z"
        fill="white"></path>
      <path
        d="M137.833 61.3354H144.17L156.914 95.0002H151.134L147.791 86.2878H134.229L130.886 95.0002H125.019L137.833 61.3354ZM146.816 82.0187L140.966 66.5977L135.117 82.0187H146.816Z"
        fill="white"></path>
      <path d="M157.106 61.3354H163.008L173.088 88.8841L183.169 61.3354H189.07L176.326 95.0002H169.954L157.106 61.3354Z"
        fill="white"></path>
      <path
        d="M195.703 61.3354H219.154V65.7788H201.396V75.9723H217.222V80.3633H201.396V90.6091H219.154V95.0002H195.703V61.3354Z"
        fill="white"></path>
      <path
        d="M225.473 61.3353H240.933C242.413 61.2149 243.901 61.4036 245.304 61.8896C246.706 62.3755 247.993 63.1481 249.081 64.1581C250.971 66.3575 251.927 69.2089 251.745 72.1038C251.833 74.2656 251.223 76.3983 250.004 78.1851C248.748 79.8844 246.957 81.1117 244.92 81.6701C245.468 82.0417 245.945 82.5078 246.33 83.0466C246.77 83.733 247.137 84.4629 247.427 85.2247L251.658 95H245.808L241.665 85.5906C241.371 84.81 240.865 84.1276 240.202 83.6216C239.381 83.1987 238.459 83.0117 237.538 83.0815H231.219V95H225.473V61.3353ZM239.401 78.4813C243.823 78.4813 246.034 76.3555 246.034 72.1038C246.034 67.8522 243.997 65.7438 239.924 65.7786H231.219V78.5336L239.401 78.4813Z"
        fill="white"></path>
      <path
        d="M267.884 61.3354H274.256L286.93 95.0002H281.081L277.738 86.2878H264.298L260.955 95.0002H255.053L267.884 61.3354ZM276.867 82.0187L271.018 66.5977L265.168 82.0187H276.867Z"
        fill="white"></path>
      <path
        d="M131.984 0H112.694L143.492 46.5416L172.827 0H141.281V21.0492H145.633V4.3562H164.941L143.492 38.5262L120.807 4.3562H131.984V0Z"
        fill="white"></path>
    </svg>
  </div>
  <div class="controls">
    <div class="param">
      <h4 id="hide_show_data_toggle">Hide data:</h4>
      <div class="checkbox-example">
        <input type="checkbox" name="hide_data" id="hide_data" checked>
        <label for="hide_data"></label>
      </div>
      <h4 id="group_entities_toggle">Ungroup Entities:</h4>
      <div class="checkbox-example">
        <input type="checkbox" name="group_entities" id="group_entities">
        <label for="group_entities"></label>
      </div>
    </div>
    <div class="explainations">
      <p><i><b>Transposing</b></i> an Entity means to put the Entity in a new context. For instance when a product moves
        from
        one
        processing step to another.</p>
      <p>An <i><b>import</b></i> signifies a relationship where one Entity depends on another. For instance a car
        depends
        on the
        metal of which it constitutes, or a consumer depends on food.</p>
    </div>
  </div>
  <div id="cy"></div>
  <script>
    let raw_json_from_api;
    const original_start_id = 99999100;
    let loading = true;

    function main() {

      // Converting JSON-encoded string to JS object
      var data_obj = JSON.parse(raw_json_from_api);
      var graph = data_obj.graph
      var nodes = graph.nodes
      var edges = graph.edges
      var value_chain_elements = []

      for (const node in nodes) {
        node_data = nodes[node]
        var checkBox = document.getElementById('group_entities');
        if (checkBox.checked == true) {
          // value_chain_elements.push({ data: { id: node, name: node_data.label, color: (node_data['meta_data'].type === "instance") ? "#c5fa9c" : "white" } })
          value_chain_elements.push({ data: { id: node, parent: node_data.parent, name: node_data.label, color: (node_data['meta_data'].type === "instance") ? "#c5fa9c" : "white" } })
          // value_chain_elements.push({ data: { id: node, name: node_data.label + ' ' + node.slice(-4), color: (node_data['meta_data'].type === "instance") ? "#c5fa9c" : "white" } })
        }
        else {
          value_chain_elements.push({ data: { id: node, name: node_data.label, color: (node_data['meta_data'].type === "instance") ? "#c5fa9c" : "white" } })
        }
      }

      start_id = original_start_id
      for (const edge in edges) {
        edge_data = edges[edge]
        value_chain_elements.push({ data: { id: start_id, desc: edge_data.relation, source: edge_data.source, target: edge_data.target } })
        start_id += 1
      }

      var cy = cytoscape({
        container: document.getElementById('cy'),
        elements: value_chain_elements,
        style: [
          {
            selector: 'node',
            css: {
              'label': 'data(name)',
              'background-color': 'data(color)',
              'border-color': 'black',
              'shape': 'circle',
              height: '50px',
              width: '50px',
              shape: 'square'
            }
          },
          {
            selector: ':parent',
            css: {
              'text-valign': 'top',
              'background-color': '#18332f',
              'text-halign': 'center',
              'padding': '30px',
              'shape': 'square',
            }
          },
          {
            selector: 'edge',
            css: {
              'line-color': '#c5fa9c',
              'label': 'data(desc)',
              'curve-style': 'bezier',
              'arrow-scale': '2',
              'target-arrow-color': '#c5fa9c',
              'target-arrow-shape': 'triangle'
            }
          },
          {
            selector: 'label',
            style: {
              'font-size': '22px',
              'text-background-color': 'black',
              'color': 'white',
              'text-background-opacity': 1,
            }
          },
          {
            selector: ':parent > node',
            style: {
              'text-background-color': '#18332f',
              'color': 'white',
              'background-color': '#c5fa9c'
            }
          },
        ],
      });

      const dataset_nodes = cy.elements('node[color = "white"]')
      const dataset_edges = cy.edges('[desc = "data"]');

      hideData();
      const cb = document.querySelector('#hide_data');
      cb.onclick = () => {
        hideData();
      };

      function hideData() {
        var checkBox = document.getElementById('hide_data');
        if (checkBox.checked == true) {
          cy.remove(dataset_nodes);
          cy.remove(dataset_edges);
          document.querySelector('#hide_show_data_toggle').innerHTML = "Show data";
          animate();
        }
        else {
          cy.add(dataset_nodes);
          cy.add(dataset_edges);
          document.querySelector('#hide_show_data_toggle').innerHTML = "Hide data";
          animate();
        }
      }

      function getParent(target_id) {
        for (node in nodes) {
          const node_data = nodes[node]
          if (node === target_id) {
            return node_data.parent
          }
        }
        return -1
      }

      // Need to check if the edge has a source that is equal to the parent of the target node
      if (document.getElementById('group_entities').checked) {
        document.querySelector('#group_entities_toggle').innerHTML = "Ungroup Entities";
        for (let i = 0; i < edges.length; i++) {
          const edge = edges[i];
          const source_node = edge.source
          const target_node = edge.target
          if (getParent(target_node) === edge.source) {
            const q = '[target = "' + target_node + '"][source = "' + source_node + '"]'
            const edge_to_be_removed = cy.edges(q);
            cy.remove(edge_to_be_removed)
          }
        }
        animate();
      }
      else {
        document.querySelector('#group_entities_toggle').innerHTML = "Group Entities";
      }


      var layout = cy.layout({
        name: 'circle',
        padding: 1000,
      });
      layout.run();

      function animate() {
        var layout = cy.layout({
          name: 'dagre',
          animate: true,
          rankDir: 'RL',
          edgeSep: 90,
          rankSep: 140,
          nodeDimensionsIncludeLabels: true,
        });
        layout.run();
      }
      setTimeout(
        animate, 1000);
    }

    //check group entities as default
    function check() {
      let inputs = document.getElementById('group_entities');
      inputs.checked = true;
    }
    check()


    // Get data and call main
    async function start() {
      let myPromise = new Promise(function (myResolve, myReject) {
        setTimeout(function () {
          let req = new XMLHttpRequest();
          req.open('GET', "eval.json");
          req.onload = function () {
            if (req.status == 200) {
              myResolve(req.response);
            } else {
              myReject("File not Found");
            }
          };
          req.send();
        }, 1900);
      });

      myPromise.then(
        function (value) {
          raw_json_from_api = value;
          main();
          document.getElementById('loading').style.opacity = 0;
          document.getElementById('loading').style['z-index'] = -1;
        },
        function (error) { alert(error); }
      );
    }
    start();

    const ge = document.querySelector('#group_entities');
    ge.onclick = () => {
      main();
      ge.checked
    };
  </script>
</body>

</html>