<!DOCTYPE html>
<html lang="en">

<!-- https://blog.js.cytoscape.org/2016/05/24/getting-started/ -->

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVF Value Chain</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.20.0/cytoscape.min.js"
        integrity="sha512-cjmYAonfXK+azDmWqvnqq8xmygHRHqVI7S0zuRxQnvcYVeoakwthRX6pPKoXfG1oIjDvMUtteRV9PhQjJwKWxQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-klay@3.1.4/cytoscape-klay.min.js"></script>
</head>

<style>
    #cy {
        width: 100%;
        height: 100%;
        position: absolute;
        background-color: black;
        top: 0px;
        left: 0px;
    }
</style>

<body>
    <div id="cy"></div>
    <script>
        var raw_json_from_api = `{
            "graph": {
                "nodes": {
                    "1": {
                        "label": "Entity 1",
                        "meta-data": {
                            "id": "1",
                            "type": "Entity"
                        }
                    },
                    "2": {
                        "label": "Dataset 1",
                        "meta-data": {
                            "id": "1",
                            "type": "Dataset"
                        }
                    },
                    "3": {
                        "label": "Entity 2",
                        "meta-data": {
                            "id": "2",
                            "type": "Entity"
                        }
                    },
                    "4": {
                        "label": "Entity 3",
                        "meta-data": {
                            "id": "3",
                            "type": "Entity"
                        }
                    }
                },
                "edges": [
                    {"source": "2", "target": "1", "relation": "data"},
                    {"source": "2", "target": "3", "relation": "data"},
                    {"source": "1", "target": "3", "relation": "deliverable"},
                    {"source": "4", "target": "1", "relation": "provider"}
                ]
            }
        }`

        // Converting JSON-encoded string to JS object
        var data_obj = JSON.parse(raw_json_from_api);
        var graph = data_obj.graph
        var nodes = graph.nodes
        var edges = graph.edges

        var value_chain_elements = []

        for (const node in nodes) {
            node_data = nodes[node]
            value_chain_elements.push({ data: { id: node, name: node_data.label, color: (node_data['meta-data'].type === "Entity") ? "#c5fa9c" : "white" } })
        }
        start_id = 99999100
        for (const edge in edges) {
            edge_data = edges[edge]
            value_chain_elements.push({ data: { id: start_id, desc: edge_data.relation, source: edge_data.source, target: edge_data.target } })
            start_id += 1
        }

        console.log(value_chain_elements)

        var cy = cytoscape({
            container: document.getElementById('cy'),
            elements: value_chain_elements,
            style: [
                {
                    selector: 'node',
                    style: {
                        shape: 'square',
                        'background-color': 'data(color)',
                        label: 'data(name)',
                        color: 'white',
                        'font-size': '22px',
                        height: '60px',
                        width: '60px',
                        transition: 'all',
                        'transition-duration': '2s',
                        'transition-timing-function': 'ease-in-out',
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 3,
                        'line-color': '#c5fa9c',
                        label: 'data(desc)',
                        color: 'white',
                        'font-size': '22px',
                        'curve-style': 'haystack',
                        transition: 'all',
                        'transition-duration': '2s',
                        'transition-timing-function': 'ease-in-out',
                        'target-arrow-color': '#ccc',
                        'target-arrow-shape': 'triangle'
                    }
                },
                {
                    selector: 'label',
                    style: {
                        'font-size': '22px',
                        'text-background-color': 'black',
                        'color': 'white',
                        'text-background-opacity': 1,
                    }
                }
            ],
        });
        var layout = cy.layout({
            name: 'circle',
            padding: 600,
        });
        layout.run();
        function animate() {
            console.log('delay')
            var layout = cy.layout({
                name: 'breadthfirst',
                animate: true,
            });
            layout.run();
        }
        setTimeout(
            animate, 1000);

    </script>
</body>

</html>